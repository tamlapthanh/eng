<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English 2/7</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #canvas-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #canvas {
      width: 100%;
      height: 100%;
    }
    .play-icon {
      cursor: pointer;
    }
    .setting-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    
    /* Buttons positioned on the sides */
    .side-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      font-size: 15px; /* Smaller icon size */
      width: 28px; /* Smaller button size */
      height: 28px; /* Smaller button size */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0; /* Remove padding */
    }
    .left-btn {
      left: 10px;
    }
    .right-btn {
      right: 10px;
    }

  </style>
</head>
<body>
  <div id="canvas-container">
    <div id="canvas"></div>
    <button class="btn btn-primary setting-btn" data-bs-toggle="modal" data-bs-target="#settingsModal">Settings</button>

<!-- New Buttons with Icons -->
<button id="previous_page" class="btn btn-primary side-btn left-btn">
  <i class="bi bi-chevron-left"></i> <!-- Previous Page Icon -->
</button>
<button id="next_page"  class="btn btn-primary side-btn right-btn">
  <i class="bi bi-chevron-right"></i> <!-- Next Page Icon -->
</button>

  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="file" id="upload-image" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="json-dropdown" class="form-label">Select JSON Config</label>
            <select id="json-dropdown" class="form-select">
              <option value="1" selected="selected">Page 1</option>
              <option value="2">Page 2</option>
              <option value="3">Page 3</option>
              <!-- Thêm nhiều tùy chọn JSON nếu cần -->
            </select>
          </div>
          <button id="load-json" class="btn btn-secondary">Load JSON</button>
          <button id="add-icon" class="btn btn-success">Add Play Icon</button>
        </div>
        <div>
          <button id="save-json" class="btn btn-primary">Save JSON</button>
        </div>
        <div>
          <button id="clearButton" class="btn btn-danger">Clear</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Icon Modal -->
  <div class="modal fade" id="editIconModal" tabindex="-1" aria-labelledby="editIconModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editIconModalLabel">Edit Icon</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="icon-sound-url" class="form-label">Sound URL or Filename</label>
            <input type="text" id="icon-sound-url" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="icon-x" class="form-label">X Position</label>
            <input type="number" id="icon-x" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="icon-y" class="form-label">Y Position</label>
            <input type="number" id="icon-y" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="save-icon" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      const stage = new Konva.Stage({
        container: 'canvas',
        width: window.innerWidth,
        height: window.innerHeight,
      });

      let  IS_EDIT_MODE = false;
      let PATH_SOUND = "assets/sound/student/";
      let CURRENT_PAGE_INDEX = 1;
      let PATH_JSON = "assets/data/page_X.json";
      const backgroundLayer = new Konva.Layer();
      const iconLayer = new Konva.Layer();
      stage.add(backgroundLayer);
      stage.add(iconLayer);

      const imageFileInput = $('#upload-image');
      const loadJsonButton = $('#load-json');
      const addIconButton = $('#add-icon');
      const jsonDropdown = $('#json-dropdown');
      const editIconModal = new bootstrap.Modal($('#editIconModal')[0]);
      const iconSoundUrlInput = $('#icon-sound-url');
      const iconXInput = $('#icon-x');
      const iconYInput = $('#icon-y');
      const saveIconButton = $('#save-icon');
      const saveJsonButton = $('#save-json');

      const previous_page = $('#previous_page');
      const next_page = $('#next_page');
      

      let backgroundImage = null;
      let playIcons = [];
      let currentIcon = null;
      let audio = null;

      function playSound(fileName) {       
        if (fileName) {
          let url = PATH_SOUND + fileName;
          if (null == audio) {
            audio = new Audio(url);
            audio.play();
          } else {
            audio.pause();
            audio = new Audio(url);
            audio.play();
          }
        }
      }

      function addPlayIcon(x, y, sound) {
        Konva.Image.fromURL('assets/play_icon.png', function(icon) {
          icon.setAttrs({
            x: x || Math.random() * (stage.width() - 50),
            y: y || Math.random() * (stage.height() - 50),
            width: 28,
            height: 28,
          });
      
          icon.setAttr('sound', sound || '');
          icon.draggable(true);
      
          function handleInteraction() {
            currentIcon = icon;
            iconSoundUrlInput.val(icon.getAttr('sound') || '');
            iconXInput.val(icon.x());
            iconYInput.val(icon.y());
            if (icon.getAttr('sound') && IS_EDIT_MODE == false) {
              playSound(icon.getAttr('sound'));
            } else {
              editIconModal.show();
            }
          }
      
          icon.on('click', handleInteraction);
          icon.on('touchend', handleInteraction);
      
          playIcons.push(icon);
      
          // Change cursor on hover
          icon.on('mouseover', function() {
            document.body.style.cursor = 'pointer';
            
          });
          icon.on('mouseout', function() {
            document.body.style.cursor = 'default';
          });
      
          iconLayer.add(icon);
          icon.moveToTop();
          iconLayer.batchDraw();
        });
      }
      

      addIconButton.on('click', function() {
        addPlayIcon();
      });

      function loadJsonBackgroundAndIcons(data) {
        if (data.background) {
            const imageObj = new Image();
            imageObj.onload = function() {
                if (backgroundImage) backgroundImage.destroy();
    
                adjustBackgroundImage(imageObj);
    
                // Xóa các icon hiện có
                playIcons.forEach(icon => icon.destroy());
                playIcons = [];
    
                // Tính toán vị trí mới của các icon dựa trên kích thước hình nền mới
                data.icons.forEach(iconData => {
                    const iconX = iconData.x * backgroundImage.width() + backgroundImage.x();
                    const iconY = iconData.y * backgroundImage.height() + backgroundImage.y();
                    addPlayIcon(iconX, iconY, iconData.sound);
                });
            };
            imageObj.src = data.background;
        }
      }

      // Đảm bảo gọi adjustBackgroundImage khi tải hình ảnh mới
      imageFileInput.change(function() {
        const file = this.files[0];
        if (file) {
           IS_EDIT_MODE = true;
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageObj = new Image();
                imageObj.onload = function() {
                    if (backgroundImage) backgroundImage.destroy();
                    adjustBackgroundImage(imageObj);
                };
                imageObj.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
      });

      function loadPage() {
        CURRENT_PAGE_INDEX = parseInt(jsonDropdown.val(), 10);

        if (CURRENT_PAGE_INDEX) {
          const urlJson = PATH_JSON.replace("X",  CURRENT_PAGE_INDEX); 
          fetch(urlJson)
            .then(response => response.json())
            .then(data => {
              backgroundLayer.clear();
              iconLayer.clear();
              loadJsonBackgroundAndIcons(data);
            })
            .catch(error => console.error('Error loading JSON:', error));
        } else {
          CURRENT_PAGE_INDEX = 1;
          loadPage();
        }
        fitStageIntoParentContainer();
      }
      loadJsonButton.on('click', function() {
        loadPage();
      });

      function adjustBackgroundImage(imageObj) {
        const imageWidth = imageObj.width;
        const imageHeight = imageObj.height;

        const stageWidth = stage.width();
        const stageHeight = stage.height();

        const aspectRatio = imageWidth / imageHeight;
        let newWidth, newHeight;

        if (stageWidth / stageHeight > aspectRatio) {
          newWidth = stageHeight * aspectRatio;
          newHeight = stageHeight;
        } else {
          newWidth = stageWidth;
          newHeight = stageWidth / aspectRatio;
        }

        backgroundImage = new Konva.Image({
          x: (stageWidth - newWidth) / 2,
          y: (stageHeight - newHeight) / 2,
          image: imageObj,
          width: newWidth,
          height: newHeight,
        });

        backgroundLayer.add(backgroundImage);
        backgroundLayer.batchDraw();
        stage.find('Image').forEach((image) => {
          image.moveToBottom();
        });
        stage.on('resize', function() {
          fitStageIntoParentContainer();
        });
        fitStageIntoParentContainer();
      }

      function fitStageIntoParentContainer() {
        stage.width(window.innerWidth);
        stage.height(window.innerHeight);
        stage.batchDraw();
      }

      window.addEventListener('resize', loadPage);

      saveIconButton.on('click', function() {
        if (currentIcon) {
          currentIcon.setAttrs({
            x: parseFloat(iconXInput.val()) || currentIcon.x(),
            y: parseFloat(iconYInput.val()) || currentIcon.y(),
            sound: iconSoundUrlInput.val()
          });
          iconLayer.batchDraw();
          editIconModal.hide();
        }
      });

      saveJsonButton.on('click', function() {
        if (!backgroundImage) return;
      
        const backgroundSize = {
          width: backgroundImage.width(),
          height: backgroundImage.height(),
        };
      
        const data = {
          background: backgroundImage.image().src,
          icons: playIcons.map(icon => ({
            x: (icon.x() - backgroundImage.x()) / backgroundSize.width,
            y: (icon.y() - backgroundImage.y()) / backgroundSize.height,
            sound: icon.getAttr('sound')
          })),
          backgroundSize: backgroundSize // Lưu kích thước hình nền hiện tại
        };
      
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        $('<a></a>')
          .attr('href', url)
          .attr('download', 'config.json')
          .appendTo('body')[0].click();
        URL.revokeObjectURL(url);
      });

      // Hàm để xóa tất cả các play icon và làm lại từ đầu, bao gồm cả hình nền
  function clearCanvas() {
    IS_EDIT_MODE = false;
    // Xóa tất cả các play icons
    playIcons.forEach(function(icon) {
      icon.destroy();  // Xóa biểu tượng khỏi layer
    });
    playIcons = [];  // Xóa danh sách biểu tượng
    iconLayer.batchDraw();  // Vẽ lại layer để cập nhật sự thay đổi

    // Xóa hình nền
    backgroundLayer.destroyChildren();  // Xóa tất cả các thành phần trên backgroundLayer
    backgroundLayer.draw();  // Vẽ lại để cập nhật sự thay đổi

    // Thiết lập lại kích thước canvas nếu cần
    fitStageIntoParentContainer();  // Đảm bảo canvas phù hợp với kích thước mới

    // Nếu cần reset thêm gì đó như là dữ liệu hay trạng thái thì thêm vào đây
  }

  // Thêm sự kiện cho nút Clear
  function addClickAndTouchEvents(element, handler) {
    element.on('click', handler);
    element.on('touchend', handler);
  }

  previous_page.on('click', function() {
    CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX  -1 ;
    if (CURRENT_PAGE_INDEX < 1) {
      CURRENT_PAGE_INDEX = 3;
    }
    jsonDropdown.val(CURRENT_PAGE_INDEX).change();
    loadPage();
  });

  next_page.on('click', function() {
    CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX  + 1 ;
    if (CURRENT_PAGE_INDEX > 3) {
      CURRENT_PAGE_INDEX = 1;
    }
    jsonDropdown.val(CURRENT_PAGE_INDEX).change();
    loadPage();
  });

  

  const clearButton = $('#clearButton');
  addClickAndTouchEvents(clearButton, function() {
    if (confirm('Are you sure you want to clear the canvas? This action cannot be undone.')) {
      clearCanvas();
    }
  });

    // Load page 1 
    loadPage();

    });
  </script>
</body>
</html>
