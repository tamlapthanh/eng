<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English 2/7 1.0.1</title>
  <link rel="manifest" " href="manifest.json"/>
  <link rel="shortcut icon" type="image/png" href="assets/icons8-favicon-94.png"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #canvas-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #canvas {
      width: 100%;
      height: 100%;
    }
    .play-icon {
      cursor: pointer;
    }
    .setting-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    
    /* Buttons positioned on the sides */
    .side-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      font-size: 15px; /* Smaller icon size */
      width: 28px; /* Smaller button size */
      height: 28px; /* Smaller button size */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0; /* Remove padding */
    }
    .left-btn {
      left: 10px;
    }
    .right-btn {
      right: 10px;
    }

  </style>
</head>
<body>
  <div id="canvas-container">
    <div id="canvas"></div>
    <button class="btn btn-primary setting-btn" data-bs-toggle="modal" data-bs-target="#settingsModal"><i class="bi bi-gear"></i></button>

<!-- New Buttons with Icons -->
<button id="previous_page" class="btn btn-primary side-btn left-btn">
  <i class="bi bi-chevron-left"></i> <!-- Previous Page Icon -->
</button>
<button id="next_page"  class="btn btn-primary side-btn right-btn">
  <i class="bi bi-chevron-right"></i> <!-- Next Page Icon -->
</button>

  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-12" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="image-dropdown">Choose a background image:</label>
            <select id="image-dropdown" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label for="upload-image">Choose a background image:</label>
            <input type="file" id="upload-image" class="form-control" />
          </div>

          <div class="form-group">
            <label for="save-json">Save JSON file:</label>
            <button id="save-json" class="btn btn-primary" class="form-control">Save</button>
          </div>

          <div class="form-group">
            <label for="icon-sound-url" class="form-label">Sound URL or Filename</label>
            <input type="text" id="icon-sound-url" class="form-control" />
            <button type="button" id="save-icon" class="btn btn-primary">Save Icon</button>
            
          </div>

          <div class="form-group">
            <label for="json-dropdown" class="form-label">Select JSON</label>
            <select id="json-dropdown" class="form-select">
            </select>
        </div>

        <div>
          <button id="add-icon" class="btn btn-success">Add Play Icon</button>
        </div>


        <div>
          <button id="clearButton" class="btn btn-danger">Clear</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {

      const stage = new Konva.Stage({
        container: 'canvas',
        width: window.innerWidth,
        height: window.innerHeight,
      });

      let PATH_ASSETS_IMG = "https://tamlapthanh.github.io/english27/assets/img/" ;
      let  IS_EDIT_MODE = false;
      let PATH_SOUND = "assets/sound/student/";
      let CURRENT_PAGE_INDEX = 1;
      let MAX_PAGE_NUM = 67;
      let MIN_PAGE_NUM = 4
      let PATH_JSON = "assets/data/X.json";
      let PATH_IMG   = "assets/img/X.png";
      const backgroundLayer = new Konva.Layer();
      const iconLayer = new Konva.Layer();
      stage.add(backgroundLayer);
      stage.add(iconLayer);

      //const imageDropdown = $('#imageDropdown');
      const imageFileInput = $('#upload-image');
      const addIconButton = $('#add-icon');
      // const jsonDropdown = $('#json-dropdown');
      const iconSoundUrlInput = $('#icon-sound-url');
      const iconXInput = $('#icon-x');
      const iconYInput = $('#icon-y');
      const saveIconButton = $('#save-icon');
      const saveJsonButton = $('#save-json');

      const previous_page = $('#previous_page');
      const next_page = $('#next_page');
      

      let backgroundImage = null;
      let playIcons = [];
      let currentIcon = null;
      let audio = null;

      function playSound(fileName) {       
        if (fileName) {
          let url = PATH_SOUND + fileName + ".mp3";
          if (null == audio) {
            audio = new Audio(url);
            audio.play();
          } else {
            audio.pause();
            audio = new Audio(url);
            audio.play();
          }
        }
      }



      function getIconSize() {
        let  icon_size = 21;
          const width = window.innerWidth;
          const userAgent = navigator.userAgent.toLowerCase();
      
          if (width < 768 || /mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(userAgent)) {
            icon_size =  15;
          } else if ((width >= 768 && width <= 1024) || /tablet|ipad|playbook|silk/i.test(userAgent)) {
            icon_size =  17;
          } else {
            icon_size =  21;
          }

          return icon_size;
      } 

      function addPlayIcon(x, y, sound) {
        icon_size = getIconSize();
        Konva.Image.fromURL('assets/play_icon.png', function(icon) {
          icon.setAttrs({
            x: x || Math.random() * (stage.width() - 50),
            y: y || Math.random() * (stage.height() - 50),
            width: icon_size,
            height: icon_size,
          });
      
          icon.setAttr('sound', sound || '');
          // icon.draggable(true);
      
          function handleInteraction() {
              currentIcon = icon;
              iconSoundUrlInput.val(icon.getAttr('sound') || '');
              iconXInput.val(icon.x());
              iconYInput.val(icon.y());
         
              if (IS_EDIT_MODE) {
                $('#settingsModal').modal('show');
              } else {
                if (icon.getAttr('sound')) {
                  playSound(icon.getAttr('sound'));
                } else {
                  alert("Not found the sound id.")
                }
                
              }
            
          }
            /*
            if (icon.getAttr('sound')) {
              playSound(icon.getAttr('sound'));
            } else {
              console.log("Icon clicked"); // Log kiểm tra
              $('#settingsModal').modal('show');
            }
            */

      
          icon.on('click', handleInteraction);
          icon.on('touchend', handleInteraction);
      
          playIcons.push(icon);
      
          // Change cursor on hover
          icon.on('mouseover', function() {
            document.body.style.cursor = 'pointer';
            
          });
          icon.on('mouseout', function() {
            document.body.style.cursor = 'default';
          });
      
          iconLayer.add(icon);
          icon.moveToTop();
          iconLayer.batchDraw();
        });
      }
      

      $('#add-icon').on('click', function() {
        addPlayIcon();
      });

      function loadJsonBackgroundAndIcons(data) {
        if (data.background) {
            const imageObj = new Image();
            imageObj.onload = function() {
                if (backgroundImage) backgroundImage.destroy();
    
                adjustBackgroundImage(imageObj);
    
                // Xóa các icon hiện có
                playIcons.forEach(icon => icon.destroy());
                playIcons = [];
    
                // Tính toán vị trí mới của các icon dựa trên kích thước hình nền mới
                data.icons.forEach(iconData => {
                    const iconX = iconData.x * backgroundImage.width() + backgroundImage.x();
                    const iconY = iconData.y * backgroundImage.height() + backgroundImage.y();
                    addPlayIcon(iconX, iconY, iconData.sound);
                });
            };
            imageObj.src = PATH_ASSETS_IMG +  data.background;
        }
      }

      // Đảm bảo gọi adjustBackgroundImage khi tải hình ảnh mới
      imageFileInput.change(function() {
        clearCanvas();
        const file = this.files[0];
        if (file) {
           IS_EDIT_MODE = true;
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageObj = new Image();
                imageObj.onload = function() {
                    if (backgroundImage) backgroundImage.destroy();
                    adjustBackgroundImage(imageObj);
                };
                imageObj.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
      });

      function loadPage() {
        clearCanvas();
        CURRENT_PAGE_INDEX = parseInt($('#json-dropdown').val(), 10);

        if (CURRENT_PAGE_INDEX) {
          const urlJson = PATH_JSON.replace("X",  CURRENT_PAGE_INDEX); 
          fetch(urlJson)
            .then(response => response.json())
            .then(data => {
              backgroundLayer.clear();
              iconLayer.clear();
              loadJsonBackgroundAndIcons(data);
            })
            .catch(error => console.error('Error loading JSON:', error));
        } else {
          CURRENT_PAGE_INDEX = 1;
          loadPage();
        }
        fitStageIntoParentContainer();
      }

      $('#json-dropdown').change(function() {
        loadPage();
      });

      $('#image-dropdown').change(function() {
          var selectedImage = $('#image-dropdown').val();
          if (selectedImage) {
            loadBackgroundImage(selectedImage);
            $('#settingsModal').modal('hide');
          }
      });

      function adjustBackgroundImage(imageObj) {
        const imageWidth = imageObj.width;
        const imageHeight = imageObj.height;

        const stageWidth = stage.width();
        const stageHeight = stage.height();

        const aspectRatio = imageWidth / imageHeight;
        let newWidth, newHeight;

        if (stageWidth / stageHeight > aspectRatio) {
          newWidth = stageHeight * aspectRatio;
          newHeight = stageHeight;
        } else {
          newWidth = stageWidth;
          newHeight = stageWidth / aspectRatio;
        }

        backgroundImage = new Konva.Image({
          x: (stageWidth - newWidth) / 2,
          y: (stageHeight - newHeight) / 2,
          image: imageObj,
          width: newWidth,
          height: newHeight,
        });

        backgroundLayer.add(backgroundImage);
        backgroundLayer.batchDraw();
        stage.find('Image').forEach((image) => {
          image.moveToBottom();
        });
        stage.on('resize', function() {
          fitStageIntoParentContainer();
        });
        fitStageIntoParentContainer();
      }

      function fitStageIntoParentContainer() {
        stage.width(window.innerWidth);
        stage.height(window.innerHeight);
        stage.batchDraw();
      }


      window.addEventListener('resize', loadPage);

      

      saveIconButton.on('click', function() {
        if (currentIcon) {
          currentIcon.setAttrs({
            x: parseFloat(iconXInput.val()) || currentIcon.x(),
            y: parseFloat(iconYInput.val()) || currentIcon.y(),
            sound: iconSoundUrlInput.val()
          });
          iconLayer.batchDraw();
          $('#settingsModal').modal('hide');
        }
      });

      saveJsonButton.on('click', function() {
        if (!backgroundImage) return;
      
        const backgroundSize = {
          width: backgroundImage.width(),
          height: backgroundImage.height(),
        };
      
        const data = {
          background: backgroundImage.image().src,
          icons: playIcons.map(icon => ({
            x: (icon.x() - backgroundImage.x()) / backgroundSize.width,
            y: (icon.y() - backgroundImage.y()) / backgroundSize.height,
            sound: icon.getAttr('sound')
          })),
          backgroundSize: backgroundSize // Lưu kích thước hình nền hiện tại
        };
      
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        var saveFileName = $('#image-dropdown').val() + ".json";
        $('<a></a>')
          .attr('href', url)
          .attr('download',  saveFileName)
          .appendTo('body')[0].click();
        URL.revokeObjectURL(url);
      });

      // Hàm để xóa tất cả các play icon và làm lại từ đầu, bao gồm cả hình nền
  function clearCanvas() {
    if(audio) {
      audio.pause();
    }

    IS_EDIT_MODE = false;
    // Xóa tất cả các play icons
    playIcons.forEach(function(icon) {
      icon.destroy();  // Xóa biểu tượng khỏi layer
    });
    playIcons = [];  // Xóa danh sách biểu tượng
    iconLayer.batchDraw();  // Vẽ lại layer để cập nhật sự thay đổi

    // Xóa hình nền
    backgroundLayer.destroyChildren();  // Xóa tất cả các thành phần trên backgroundLayer
    backgroundLayer.draw();  // Vẽ lại để cập nhật sự thay đổi

    // Thiết lập lại kích thước canvas nếu cần
    fitStageIntoParentContainer();  // Đảm bảo canvas phù hợp với kích thước mới

    // Nếu cần reset thêm gì đó như là dữ liệu hay trạng thái thì thêm vào đây
  }

  // Thêm sự kiện cho nút Clear
  function addClickAndTouchEvents(element, handler) {
    element.on('click', handler);
    element.on('touchend', handler);
  }

  function loadBackgroundImage(imageUrl) {
    clearCanvas();
    const imageObj = new Image();
    imageObj.onload = function() {
        if (backgroundImage) backgroundImage.destroy();
        adjustBackgroundImage(imageObj);
    };
    imageUrl = PATH_IMG.replace("X", imageUrl);
    imageObj.src = imageUrl;
  }
 
  function populateDropdown(dropdown, dataFileName) {

    $.ajax({
      url: dataFileName,
      dataType: 'json',
      success: function(data) {
        // Iterate over the items and append them to the dropdown
        $.each(data.items, function(key, value) {
          $(dropdown).append($('<option></option>').attr('value', value.id).text(value.name));
        });
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.error("Failed to load JSON data: " + textStatus, errorThrown);
      }
    });
  }

  function popDropdown(dropdown, text, start, end) {
    dropdown.empty();
    // Add options dynamically
    for (var i = start; i <= end; i++) {
      var option = $('<option>', {
        value: i,
        text: text  + " " + i
      });

      // Set the default selected option
      if (i === start) {
        option.prop('selected', true);
      }

      dropdown.append(option);
    }
    
  }

  previous_page.on('click', function() {
    CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX  -1 ;
    if (CURRENT_PAGE_INDEX < 1) {
      CURRENT_PAGE_INDEX = MAX_PAGE_NUM;
    }
    $('#json-dropdown').val(CURRENT_PAGE_INDEX).change();
    //loadPage();
  });

  next_page.on('click', function() {
    CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX  + 1 ;
    if (CURRENT_PAGE_INDEX > MAX_PAGE_NUM) {
      CURRENT_PAGE_INDEX = 1;
    }
    $('#json-dropdown').val(CURRENT_PAGE_INDEX).change();
   // loadPage();
  });

  
  $('#clearButton').on('click', function() {
    clearCanvas();
    // $('#settingsModal').modal('hide');

  });

    // Load page 1
    // populateDropdown(jsonDropdown, "/assets/page.json");
    // populateDropdown(imageDropdown, "/assets/img.json");

    popDropdown ($('#json-dropdown'), "Page", MIN_PAGE_NUM, MAX_PAGE_NUM);
    popDropdown ($('#image-dropdown'), "Image", MIN_PAGE_NUM, MAX_PAGE_NUM)

    loadPage();

    });
  </script>
</body>
</html>
