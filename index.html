<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English 2/7 1.0.4</title>
  <link rel="manifest" " href=" manifest.json" />
  <link rel="shortcut icon" type="image/png" href="assets/favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }

    #canvas-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #canvas {
      width: 100%;
      height: 100%;
    }

    .play-icon {
      cursor: pointer;
    }

    .setting-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }

    .zoom-controls {
      position: absolute;
      top: 45px; /* Adjust this value to position it below the setting button */
      right: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column; /* Arrange buttons in a column */
      gap: 3px; /* Space between buttons */
      display: none; /* Ẩn trên các thiết bị lớn */
    }

    /* Media query cho thiết bị di động */
    @media (max-width: 768px) {
      .zoom-controls {
        display: flex; /* Hiển thị trên thiết bị di động */
      }
    }
    
    .small-btn {
      width: 28px; /* Adjust width for smaller button */
      height: 28px; /* Adjust height for smaller button */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 16px; /* Adjust font size for smaller icon */
    }
    
    .zoom-controls .btn {
      border-radius: 50%; /* Make buttons circular */
    }

    /* Buttons positioned on the sides */
    .side-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      font-size: 15px;
      /* Smaller icon size */
      width: 28px;
      /* Smaller button size */
      height: 28px;
      /* Smaller button size */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      /* Remove padding */
    }

    .left-btn {
      left: 10px;
    }

    .right-btn {
      right: 10px;
    }
  </style>
</head>

<body>
  <div id="canvas-container">
    <div id="canvas"></div>



    <button class="btn btn-primary setting-btn small-btn" data-bs-toggle="modal" data-bs-target="#settingsModal"><i class="bi bi-gear"></i></button>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
      <button id="zoom-in" class="btn btn-primary small-btn">
        <i class="bi bi-zoom-in"></i>
      </button>
      <button id="zoom-out" class="btn btn-primary small-btn">
        <i class="bi bi-zoom-out"></i>
      </button>
    </div>


    <!-- New Buttons with Icons -->
    <button id="previous_page" class="btn btn-primary side-btn left-btn">
      <i class="bi bi-chevron-left"></i> <!-- Previous Page Icon -->
    </button>
    <button id="next_page" class="btn btn-primary side-btn right-btn">
      <i class="bi bi-chevron-right"></i> <!-- Next Page Icon -->
    </button>

  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-12" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="settingsModalLabel">Jump to which page?</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="jump-to-index-jso" class="form-control" placeholder="page number" />
          <select id="json-dropdown" class="form-select"></select>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>

        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {

        const stage = new Konva.Stage({
          container: 'canvas',
          width: window.innerWidth,
          height: window.innerHeight,
          draggable: true,
        });

        // let PATH_ASSETS_IMG = "https://tamlapthanh.github.io/english27/assets/img/";
        let PATH_ASSETS_IMG = "assets/img/";
        let PATH_SOUND = "assets/sound/student/";
        let CURRENT_PAGE_INDEX = 4;
        let MAX_PAGE_NUM = 66;
        let MIN_PAGE_NUM = 4
        let PATH_JSON = "assets/data/X.json";
        let PATH_IMG = "assets/img/X.png";
        const backgroundLayer = new Konva.Layer();
        const iconLayer = new Konva.Layer();
        stage.add(backgroundLayer);
        stage.add(iconLayer);

        // start zoom
        let zoomLevel = 1;
        const zoomStep = 0.1;
        const minZoom = 0.5;
        const maxZoom = 2;
      
        function setZoom(scale) {
          stage.scale({ x: scale, y: scale });
          stage.batchDraw();
        }
      
        $('#zoom-in').on('click', function() {
          if (zoomLevel < maxZoom) {
            zoomLevel += zoomStep;
            setZoom(zoomLevel);
          }
        });
      
        $('#zoom-out').on('click', function() {
          if (zoomLevel > minZoom) {
            zoomLevel -= zoomStep;
            setZoom(zoomLevel);
          }
        });
      
        // Mouse wheel zoom
        stage.on('wheel', function(e) {
          e.evt.preventDefault();
          const oldScale = stage.scaleX();
          const pointer = stage.getPointerPosition();
          
          const mousePointTo = {
            x: (pointer.x - stage.x()) / oldScale,
            y: (pointer.y - stage.y()) / oldScale,
          };
          
          const direction = e.evt.deltaY > 0 ? -1 : 1;
          zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel + direction * zoomStep));
          
          setZoom(zoomLevel);
          
          const newScale = stage.scaleX();
          const newPos = {
            x: pointer.x - mousePointTo.x * newScale,
            y: pointer.y - mousePointTo.y * newScale,
          };
          
          stage.position(newPos);
          stage.batchDraw();
        });
      
        // Pinch-to-zoom for touch devices
        let isPinching = false;
        let lastScale = 1;
      
        stage.on('touchstart', function (e) {
          if (e.evt.touches.length === 2) {
            isPinching = true;
            const touch1 = e.evt.touches[0];
            const touch2 = e.evt.touches[1];
            const dx = touch1.pageX - touch2.pageX;
            const dy = touch1.pageY - touch2.pageY;
            lastScale = Math.sqrt(dx * dx + dy * dy);
          }
        });
      
        stage.on('touchmove', function (e) {
          if (isPinching && e.evt.touches.length === 2) {
            const touch1 = e.evt.touches[0];
            const touch2 = e.evt.touches[1];
            const dx = touch1.pageX - touch2.pageX;
            const dy = touch1.pageY - touch2.pageY;
            const newScale = Math.sqrt(dx * dx + dy * dy);
            const scaleChange = newScale / lastScale;
            lastScale = newScale;
      
            zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel * scaleChange));
            setZoom(zoomLevel);
      
            const pointer = stage.getPointerPosition();
            const oldScale = stage.scaleX();
            const mousePointTo = {
              x: (pointer.x - stage.x()) / oldScale,
              y: (pointer.y - stage.y()) / oldScale,
            };
      
            const updatedScale = stage.scaleX();
            const newPos = {
              x: pointer.x - mousePointTo.x * updatedScale,
              y: pointer.y - mousePointTo.y * updatedScale,
            };
            
            stage.position(newPos);
            stage.batchDraw();
          }
        });
      
        stage.on('touchend', function (e) {
          if (e.evt.touches.length < 2) {
            isPinching = false;
          }
        });

        // end zoom

        const iconSoundUrlInput = $('#icon-sound-url');
        const iconXInput = $('#icon-x');
        const iconYInput = $('#icon-y');
         const previous_page = $('#previous_page');
        const next_page = $('#next_page');

        let backgroundImage = null;
        let playIcons = [];
        let currentIcon = null;
        let audio = null;

        function playSound(fileName) {
          if (fileName && "x" != fileName) {
            let url = PATH_SOUND + fileName + ".mp3";
            if (null == audio) {
              audio = new Audio(url);
              audio.play();
            } else {
              audio.pause();
              audio = new Audio(url);
              audio.play();
            }
          }
        }



        function getIconSize() {
          let icon_size = 21;
          const width = window.innerWidth;
          const userAgent = navigator.userAgent.toLowerCase();

          if (width < 768 || /mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(userAgent)) {
            icon_size = 15;
          } else if ((width >= 768 && width <= 1024) || /tablet|ipad|playbook|silk/i.test(userAgent)) {
            icon_size = 17;
          } else {
            icon_size = 21;
          }

          return icon_size;
        }

        function addPlayIcon(x, y, sound) {

          // don't show sound icon that are x
          if ("x" == sound) {
            return ;
          }

          icon_size = getIconSize();
          Konva.Image.fromURL('assets/play_icon.png', function (icon) {
            icon.setAttrs({
              x: x || Math.random() * (stage.width() - 50),
              y: y || Math.random() * (stage.height() - 50),
              width: icon_size,
              height: icon_size,
            });

            icon.setAttr('sound', sound || '');

            function handleInteraction() {
              currentIcon = icon;
              iconSoundUrlInput.val(icon.getAttr('sound') || '');
              iconXInput.val(icon.x());
              iconYInput.val(icon.y());
              if (icon.getAttr('sound')) {
                playSound(icon.getAttr('sound'));
              } else {
                alert("Not found the sound id.")
              }
            }

            icon.on('click', handleInteraction);
            icon.on('touchend', handleInteraction);

            playIcons.push(icon);

            // Change cursor on hover
            icon.on('mouseover', function () {
              document.body.style.cursor = 'pointer';

            });
            icon.on('mouseout', function () {
              document.body.style.cursor = 'default';
            });

            iconLayer.add(icon);
            icon.moveToTop();
            iconLayer.batchDraw();
          });
        }



        function loadJsonBackgroundAndIcons(data) {
          if (data.background) {
            const imageObj = new Image();
            imageObj.onload = function () {
              if (backgroundImage) backgroundImage.destroy();

              adjustBackgroundImage(imageObj);

              // Xóa các icon hiện có
              playIcons.forEach(icon => icon.destroy());
              playIcons = [];

              // Tính toán vị trí mới của các icon dựa trên kích thước hình nền mới
              data.icons.forEach(iconData => {
                const iconX = iconData.x * backgroundImage.width() + backgroundImage.x();
                const iconY = iconData.y * backgroundImage.height() + backgroundImage.y();
                addPlayIcon(iconX, iconY, iconData.sound);
              });
            };
            imageObj.src = PATH_ASSETS_IMG + data.background;
          }
        }



        function loadPage() {
          clearCanvas();
          $('#settingsModal').modal('hide');
          CURRENT_PAGE_INDEX = parseInt($('#json-dropdown').val(), 10);

          if (CURRENT_PAGE_INDEX) {
            const urlJson = PATH_JSON.replace("X", CURRENT_PAGE_INDEX);
            fetch(urlJson)
              .then(response => response.json())
              .then(data => {
                backgroundLayer.clear();
                iconLayer.clear();
                loadJsonBackgroundAndIcons(data);
              })
              .catch(error => console.error('Error loading JSON:', error));
          } else {
            CURRENT_PAGE_INDEX = 1;
            loadPage();
          }
          fitStageIntoParentContainer();
        }

        $('#json-dropdown').change(function () {
          loadPage();

        });


        function adjustBackgroundImage(imageObj) {
          const imageWidth = imageObj.width;
          const imageHeight = imageObj.height;

          const stageWidth = stage.width();
          const stageHeight = stage.height();

          let aspectRatio = imageWidth / imageHeight;
          let newWidth, newHeight;

          if (stageWidth / stageHeight > aspectRatio) {
            newWidth = stageHeight * aspectRatio;
            newHeight = stageHeight;
          } else {
            newWidth = stageWidth;
            newHeight = stageWidth / aspectRatio;
          }

          backgroundImage = new Konva.Image({
            x: (stageWidth - newWidth) / 2,
            y: (stageHeight - newHeight) / 2,
            image: imageObj,
            width: newWidth,
            height: newHeight,
          });

          backgroundLayer.add(backgroundImage);
          backgroundLayer.batchDraw();
          stage.find('Image').forEach((image) => {
            image.moveToBottom();
          });
          stage.on('resize', function () {
            fitStageIntoParentContainer();
          });
          fitStageIntoParentContainer();
        }

        function fitStageIntoParentContainer() {
          stage.width(window.innerWidth);
          stage.height(window.innerHeight);
          stage.batchDraw();
        }


        window.addEventListener('resize', loadPage);


        // Hàm để xóa tất cả các play icon và làm lại từ đầu, bao gồm cả hình nền
        function clearCanvas() {
          if (audio) {
            audio.pause();
          }
          // Xóa tất cả các play icons
          playIcons.forEach(function (icon) {
            icon.destroy();  // Xóa biểu tượng khỏi layer
          });
          playIcons = [];  // Xóa danh sách biểu tượng
          iconLayer.batchDraw();  // Vẽ lại layer để cập nhật sự thay đổi

          // Xóa hình nền
          backgroundLayer.destroyChildren();  // Xóa tất cả các thành phần trên backgroundLayer
          backgroundLayer.draw();  // Vẽ lại để cập nhật sự thay đổi

          // Thiết lập lại kích thước canvas nếu cần
          fitStageIntoParentContainer();  // Đảm bảo canvas phù hợp với kích thước mới

          // Nếu cần reset thêm gì đó như là dữ liệu hay trạng thái thì thêm vào đây
        }

        // Thêm sự kiện cho nút Clear
        function addClickAndTouchEvents(element, handler) {
          element.on('click', handler);
          element.on('touchend', handler);
        }

        function loadBackgroundImage(imageUrl) {
          clearCanvas();
          const imageObj = new Image();
          imageObj.onload = function () {
            if (backgroundImage) backgroundImage.destroy();
            adjustBackgroundImage(imageObj);
          };
          imageUrl = PATH_IMG.replace("X", imageUrl);
          imageObj.src = imageUrl;
        }


        function popDropdown(dropdown, text, start, end) {
          dropdown.empty();
          // Add options dynamically
          for (var i = start; i <= end; i++) {
            var option = $('<option>', {
              value: i,
              text: text + " " + i
            });

            // Set the default selected option
            if (i === start) {
              option.prop('selected', true);
            }

            dropdown.append(option);
          }

        }

        previous_page.on('click', function () {
          CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX - 1;
          if (CURRENT_PAGE_INDEX < 1) {
            CURRENT_PAGE_INDEX = MAX_PAGE_NUM;
          }
          $('#json-dropdown').val(CURRENT_PAGE_INDEX).change();
        });

        next_page.on('click', function () {
          CURRENT_PAGE_INDEX = CURRENT_PAGE_INDEX + 1;
          if (CURRENT_PAGE_INDEX > MAX_PAGE_NUM) {
            CURRENT_PAGE_INDEX = 1;
          }
          $('#json-dropdown').val(CURRENT_PAGE_INDEX).change();
        });

        $('#jump-to-index-jso').on('change', function () {
          var inputValue = $(this).val();
          $('#json-dropdown').val(inputValue).change();
        });

        $('#clearButton').on('click', function () {
          clearCanvas();
        });


        popDropdown($('#json-dropdown'), "Page", MIN_PAGE_NUM, MAX_PAGE_NUM);
        loadPage();

      });
    </script>
</body>

</html>